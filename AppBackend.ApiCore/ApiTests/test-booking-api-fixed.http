### ============================================
### BOOKING API - COMPLETE TEST SUITE (FIXED VERSION)
### ============================================
### Táº¡o dá»±a trÃªn SeedingData.cs vÃ  BookingService.cs
### Response validation Ä‘Æ°á»£c sá»­a Ä‘Ãºng theo actual API response structure
### Date: 2025-10-31
### ============================================

### Variables
@baseUrl = http://localhost:8080
@apiUrl = {{baseUrl}}/api

### ============================================
### SECTION 1: AUTHENTICATION & SETUP
### ============================================

### 1.1 Register New Customer (Test User 1)
POST {{apiUrl}}/Authentication/register
Content-Type: application/json

{
  "username": "testbooking1",
  "email": "nam_testing@gmail.com",
  "password": "Booking@123",
  "fullName": "Nguyen Van A",
  "phoneNumber": "0901234567",
  "identityCard": "001234567890",
  "address": "123 Nguyen Hue, Q1, HCMC"
}

> {%
    client.test("Register customer 1 - Full validation", function() {
        client.assert(response.status === 200 || response.status === 201, "Should register successfully");
        client.assert(response.body.isSuccess === true, "Should be successful");
        client.assert(response.body.message !== null, "Should have message");
        
        // Validate response structure
        var data = response.body.data;
        client.assert(data !== null, "Should have data");
        client.assert(data.token !== null, "Should return token (lowercase)");
        client.assert(data.refreshToken !== null, "Should return refreshToken (lowercase)");
        client.assert(Array.isArray(data.roles), "Should return roles array");
        client.assert(data.roles.length > 0, "Should have at least one role");
    });
    
    if (response.body.data && response.body.data.token) {
        client.global.set("customer1_token", response.body.data.token);
        client.global.set("customer1_refresh", response.body.data.refreshToken);
        
        client.log("========================================");
        client.log("âœ… CUSTOMER 1 REGISTERED");
        client.log("========================================");
        client.log("ðŸ“§ Email: testbooking1@gmail.com");
        client.log("ðŸ” Password: Booking@123");
        client.log("ðŸ”‘ Token: " + response.body.data.token.substring(0, 30) + "...");
        client.log("ðŸ”„ Refresh Token saved");
        client.log("ðŸ‘¥ Roles: " + response.body.data.roles.join(", "));
        client.log("ðŸ’¬ Message: " + response.body.message);
        client.log("========================================");
    }
%}

### 1.2 Login Customer 1 (If already registered)
POST {{apiUrl}}/Authentication/login
Content-Type: application/json

{
  "email": "testbooking1@gmail.com",
  "password": "Booking@123"
}

> {%
    client.test("Login customer 1 - Full validation", function() {
        client.assert(response.status === 200, "Should login successfully");
        client.assert(response.body.isSuccess === true, "Should be successful");
        
        var data = response.body.data;
        client.assert(data !== null, "Should have data");
        client.assert(data.token !== null, "Should return token");
        client.assert(typeof data.token === "string", "Token should be string");
        client.assert(data.refreshToken !== null, "Should return refreshToken");
        client.assert(Array.isArray(data.roles), "Should return roles array");
    });
    
    if (response.body.data && response.body.data.token) {
        client.global.set("customer1_token", response.body.data.token);
        client.global.set("customer1_refresh", response.body.data.refreshToken);
        
        client.log("âœ… Customer 1 logged in successfully");
        client.log("ðŸ‘¥ Roles: " + response.body.data.roles.join(", "));
        client.log("ðŸ”‘ Token saved to: customer1_token");
    }
%}

### 1.3 Register Customer 2 (For concurrent booking tests)
POST {{apiUrl}}/Authentication/register
Content-Type: application/json

{
  "username": "testbooking2",
  "email": "testbooking2@gmail.com",
  "password": "Booking@123",
  "fullName": "Tran Thi B",
  "phoneNumber": "0902345678",
  "identityCard": "001234567891",
  "address": "456 Le Loi, Q3, HCMC"
}

> {%
    client.test("Register customer 2", function() {
        client.assert(response.status === 200 || response.status === 201, "Should register successfully");
        if (response.body.data) {
            client.assert(response.body.data.token !== null, "Should return token");
            client.assert(Array.isArray(response.body.data.roles), "Should return roles array");
        }
    });
    
    if (response.body.data && response.body.data.token) {
        client.global.set("customer2_token", response.body.data.token);
        client.log("âœ… Customer 2 registered - Token saved");
        client.log("ðŸ‘¥ Roles: " + response.body.data.roles.join(", "));
    }
%}

### 1.4 Login as Admin
POST {{apiUrl}}/Authentication/login
Content-Type: application/json

{
  "email": "admin@hotel.com",
  "password": "Admin@123"
}

> {%
    client.test("Login admin", function() {
        client.assert(response.status === 200, "Should login successfully");
        if (response.body.data) {
            client.assert(response.body.data.token !== null, "Should return token");
            client.assert(Array.isArray(response.body.data.roles), "Should have roles");
            // Admin should have Admin role
            var hasAdminRole = response.body.data.roles.some(function(role) {
                return role === "Admin" || role === "Manager";
            });
            client.assert(hasAdminRole, "Admin should have Admin or Manager role");
        }
    });
    
    if (response.body.data && response.body.data.token) {
        client.global.set("admin_token", response.body.data.token);
        client.log("âœ… Admin logged in - Token saved");
        client.log("ðŸ‘¥ Roles: " + response.body.data.roles.join(", "));
    }
%}

### ============================================
### SECTION 2: CHECK ROOM AVAILABILITY (DETAILED TESTS)
### ============================================

### 2.1 Check availability - Standard rooms (Based on seeding data)
# RoomTypeId 1 = "PhÃ²ng TiÃªu Chuáº©n" (STD) - 800,000 VNÄ/night
POST {{apiUrl}}/Booking/check-availability
Content-Type: application/json

{
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 2 }
  ],
  "checkInDate": "2025-11-05T14:00:00Z",
  "checkOutDate": "2025-11-07T12:00:00Z"
}

> {%
    client.test("Check availability - Response structure", function() {
        client.assert(response.status === 200 || response.status === 409, "Should return 200 or 409");
        client.assert(response.body.isSuccess === true, "Should be successful");
        client.assert(response.body.data !== null, "Should have data");
        client.assert(response.body.data.roomTypes !== null, "Should have roomTypes array");
        client.assert(response.body.data.totalNights === 2, "Should calculate 2 nights");
        client.assert(typeof response.body.data.isAllAvailable === "boolean", "isAllAvailable should be boolean");
    });
    
    client.log("========================================");
    client.log("ðŸ“Š AVAILABILITY CHECK RESULT");
    client.log("========================================");
    client.log("ðŸ“… Check-in: 2025-11-05");
    client.log("ðŸ“… Check-out: 2025-11-07");
    client.log("ðŸŒ™ Total nights: " + response.body.data.totalNights);
    client.log("âœ… All available: " + response.body.data.isAllAvailable);
    client.log("ðŸ’¬ Message: " + response.body.data.message);
    client.log("");
    
    if (response.body.data && response.body.data.roomTypes) {
        response.body.data.roomTypes.forEach(function(rt) {
            client.log("ðŸ¨ " + rt.roomTypeName + " (" + rt.roomTypeCode + ")");
            client.log("   ðŸ“‹ Description: " + rt.description);
            client.log("   ðŸ’° Price/night: " + rt.basePriceNight.toLocaleString() + " VNÄ");
            client.log("   ðŸ‘¥ Max occupancy: " + rt.maxOccupancy + " ngÆ°á»i");
            client.log("   ðŸ“ Room size: " + rt.roomSize + "mÂ²");
            client.log("   ðŸ›ï¸  Beds: " + rt.numberOfBeds + " x " + rt.bedType);
            client.log("   ðŸ“Š Available: " + rt.availableCount + "/" + rt.requestedQuantity);
            client.log("   " + (rt.isAvailable ? "âœ…" : "âŒ") + " " + rt.message);
            client.log("   ðŸ–¼ï¸  Images: " + rt.images.length + " photos");
            client.log("");
        });
    }
    client.log("========================================");
%}

### 2.2 Check availability - Deluxe rooms
# RoomTypeId 2 = "PhÃ²ng Cao Cáº¥p" (DLX) - 1,500,000 VNÄ/night
POST {{apiUrl}}/Booking/check-availability
Content-Type: application/json

{
  "roomTypes": [
    { "roomTypeId": 2, "quantity": 1 }
  ],
  "checkInDate": "2025-11-10T14:00:00Z",
  "checkOutDate": "2025-11-13T12:00:00Z"
}

> {%
    client.test("Deluxe room check", function() {
        if (response.body.data && response.body.data.totalNights) {
            client.assert(response.body.data.totalNights === 3, "Should calculate 3 nights");
        }
    });
    
    client.log("âœ… Deluxe room availability checked (3 nights)");
    if (response.body.data && response.body.data.roomTypes && response.body.data.roomTypes[0]) {
        var deluxe = response.body.data.roomTypes[0];
        client.log("   Price: " + deluxe.basePriceNight.toLocaleString() + " VNÄ/night");
        client.log("   Total estimate: " + (deluxe.basePriceNight * 3).toLocaleString() + " VNÄ");
    }
%}

### ============================================
### SECTION 3: CREATE BOOKING (Authenticated User)
### ============================================

### 3.1 Create booking - 2 Standard rooms (MAIN TEST)
# âš ï¸ IMPORTANT: Thay customerId=4 báº±ng ID customer thá»±c táº¿ cá»§a báº¡n
POST {{apiUrl}}/Booking
Content-Type: application/json
Authorization: Bearer {{customer1_token}}

{
  "customerId": 4,
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 2 }
  ],
  "checkInDate": "2025-11-05T14:00:00Z",
  "checkOutDate": "2025-11-07T12:00:00Z",
  "specialRequests": "Non-smoking rooms, early check-in if possible"
}

> {%
    client.test("Create booking - Full validation", function() {
        client.assert(response.status === 201, "Status should be 201 Created");
        client.assert(response.body.isSuccess === true, "Should be successful");
        client.assert(response.body.statusCode === 201, "StatusCode should be 201");
        client.assert(response.body.message !== null, "Should have message");
        
        // Validate data structure
        var data = response.body.data;
        client.assert(data !== null, "Should have data");
        client.assert(data.bookingId > 0, "Should have valid booking ID");
        client.assert(data.customerId > 0, "Should have customer ID");
        client.assert(data.customerName !== "", "Should have customer name");
        client.assert(data.roomIds.length === 2, "Should have 2 rooms");
        client.assert(data.roomNames.length === 2, "Should have 2 room names");
        client.assert(data.totalAmount > 0, "Should have total amount");
        client.assert(data.depositAmount > 0, "Should have deposit amount");
        client.assert(data.depositAmount === data.totalAmount * 0.3, "Deposit should be 30%");
        client.assert(data.paymentUrl !== null, "Should have payment URL");
        client.assert(data.paymentUrl.includes("payos") || data.paymentUrl.includes("pay"), "Payment URL should be valid");
        client.assert(data.roomTypeDetails.length > 0, "Should have room type details");
    });
    
    if (response.body.data && response.body.data.bookingId) {
        client.global.set("booking_id_1", response.body.data.bookingId);
        client.global.set("payment_url_1", response.body.data.paymentUrl);
        client.global.set("room_ids_1", JSON.stringify(response.body.data.roomIds));
        
        client.log("========================================");
        client.log("âœ… BOOKING CREATED SUCCESSFULLY");
        client.log("========================================");
        client.log("ðŸ“‹ Booking ID: " + response.body.data.bookingId);
        client.log("ðŸ‘¤ Customer: " + response.body.data.customerName + " (ID: " + response.body.data.customerId + ")");
        client.log("");
        client.log("ðŸ¨ ROOMS BOOKED:");
        response.body.data.roomNames.forEach(function(name, index) {
            client.log("   " + (index + 1) + ". " + name + " (ID: " + response.body.data.roomIds[index] + ")");
        });
        client.log("");
        client.log("ðŸ“… Check-in: " + new Date(response.body.data.checkInDate).toLocaleString());
        client.log("ðŸ“… Check-out: " + new Date(response.body.data.checkOutDate).toLocaleString());
        client.log("");
        client.log("ðŸ’° PRICING:");
        response.body.data.roomTypeDetails.forEach(function(rt) {
            var nights = 2;
            var subtotal = rt.pricePerNight * rt.quantity * nights;
            client.log("   " + rt.roomTypeName + " (" + rt.roomTypeCode + "):");
            client.log("     " + rt.quantity + " phÃ²ng x " + rt.pricePerNight.toLocaleString() + " VNÄ x " + nights + " nights");
            client.log("     = " + subtotal.toLocaleString() + " VNÄ");
        });
        client.log("");
        client.log("ðŸ’° Total Amount: " + response.body.data.totalAmount.toLocaleString() + " VNÄ");
        client.log("ðŸ’µ Deposit (30%): " + response.body.data.depositAmount.toLocaleString() + " VNÄ");
        client.log("ðŸ’µ Remaining: " + (response.body.data.totalAmount - response.body.data.depositAmount).toLocaleString() + " VNÄ");
        client.log("");
        client.log("ðŸ’³ Payment URL: " + response.body.data.paymentUrl);
        client.log("");
        client.log("â° IMPORTANT NOTES:");
        client.log("   âš ï¸  Pay within 15 minutes or booking will be auto-cancelled!");
        client.log("   ðŸ”’ Rooms are locked in cache for payment");
        client.log("   ðŸ“¨ Confirmation email will be sent after payment");
        client.log("   ðŸŽ« Queue message created for background processing");
        client.log("========================================");
    } else {
        client.log("âŒ Failed to create booking");
        client.log("Message: " + response.body.message);
    }
%}

### 3.2 Cancel booking - Test queue processing
DELETE {{apiUrl}}/Booking/{{booking_id_1}}
Authorization: Bearer {{customer1_token}}

> {%
    client.test("Cancel booking - Validation", function() {
        client.assert(response.status === 200, "Should cancel successfully");
        client.assert(response.body.isSuccess === true, "Should be successful");
        client.assert(response.body.message !== null, "Should have message");
    });
    
    client.log("========================================");
    client.log("âœ… BOOKING CANCELLED");
    client.log("========================================");
    client.log("ðŸ“‹ Booking ID: " + client.global.get("booking_id_1"));
    client.log("ðŸ’¬ Message: " + response.body.message);
    client.log("");
    client.log("ðŸŽ« QUEUE PROCESSING:");
    client.log("   âœ“ Cancel message enqueued");
    client.log("   âœ“ Room locks will be released");
    client.log("   âœ“ Payment cache will be cleared");
    client.log("   âœ“ Booking record will be deleted");
    client.log("========================================");
%}

### ============================================
### TESTING NOTES
### ============================================
# 
# âœ… FIXES APPLIED:
# 
# 1. AUTHENTICATION RESPONSE (CRITICAL FIX):
#    - Changed: data.Token â†’ data.token (lowercase)
#    - Changed: data.RefreshToken â†’ data.refreshToken (lowercase)
#    - Changed: data.Roles â†’ data.roles (lowercase array)
#    - REMOVED: data.accountId (KHÃ”NG Tá»’N Táº I trong API response!)
#
# 2. RESPONSE VALIDATION:
#    - Added proper null checks for all data access
#    - Validate response structure before accessing properties
#    - Check data types (string, array, boolean, number)
#
# 3. BOOKING RESPONSE:
#    - Properly validated all booking fields
#    - Check payment URL format
#    - Validate room counts and amounts
#
# ðŸ”§ CUSTOMIZATION:
# - Change customerId from 4 to your actual customer ID
# - Get customerId by querying Customer table or from registration
# - Adjust dates to future dates as needed
#
# ðŸ“Š API RESPONSE STRUCTURE (ACTUAL):
#
# Login/Register Response:
# {
#   "isSuccess": true,
#   "message": "...",
#   "data": {
#     "token": "eyJ...",
#     "refreshToken": "guid...",
#     "roles": ["User"]
#   }
# }
#
# Booking Response:
# {
#   "isSuccess": true,
#   "message": "...",
#   "statusCode": 201,
#   "data": {
#     "bookingId": 1,
#     "customerId": 4,
#     "customerName": "...",
#     "roomIds": [1, 2],
#     "roomNames": ["Room 101", "Room 102"],
#     "roomTypeDetails": [...],
#     "checkInDate": "...",
#     "checkOutDate": "...",
#     "totalAmount": 3200000,
#     "depositAmount": 960000,
#     "paymentUrl": "https://...",
#     "createdAt": "..."
#   }
# }
#
# ============================================

