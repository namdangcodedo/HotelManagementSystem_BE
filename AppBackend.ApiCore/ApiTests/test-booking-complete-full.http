### ============================================
### BOOKING API - COMPLETE TEST SUITE (FULL VERSION)
### ============================================
### Táº¡o dá»±a trÃªn SeedingData.cs vÃ  BookingService.cs
### Bao gá»“m: Check availability, Create booking, Cancel, Queue processing, Response validation
### Date: 2025-10-31
### ============================================

### Variables
@baseUrl = http://localhost:8080
@apiUrl = {{baseUrl}}/api

### ============================================
### SECTION 1: AUTHENTICATION & SETUP
### ============================================

### 1.1 Register New Customer (Test User 1)
POST {{apiUrl}}/Authentication/register
Content-Type: application/json

{
  "username": "testbooking1",
  "email": "testbooking1@gmail.com",
  "password": "Booking@123",
  "fullName": "Nguyen Van A",
  "phoneNumber": "0901234567",
  "identityCard": "001234567890",
  "address": "123 Nguyen Hue, Q1, HCMC"
}

> {%
    client.global.set("customer1_token", response.body.data.token);
    client.global.set("customer1_id", response.body.data.accountId);
    
    client.test("Register customer 1", function() {
        client.assert(response.status === 200 || response.status === 201, "Should register successfully");
    });
    
    client.log("========================================");
    client.log("âœ… CUSTOMER 1 REGISTERED");
    client.log("========================================");
    client.log("ğŸ‘¤ Account ID: " + response.body.data.accountId);
    client.log("ğŸ“§ Email: testbooking1@gmail.com");
    client.log("ğŸ” Password: Booking@123");
    client.log("ğŸ”‘ Token saved to: customer1_token");
    client.log("========================================");
%}

### 1.2 Login Customer 1 (If already registered)
POST {{apiUrl}}/Authentication/login
Content-Type: application/json

{
  "email": "testbooking1@gmail.com",
  "password": "Booking@123"
}

> {%
    client.global.set("customer1_token", response.body.data.token);
    client.global.set("customer1_id", response.body.data.accountId);
    
    client.test("Login customer 1", function() {
        client.assert(response.status === 200, "Should login successfully");
        client.assert(response.body.data.token !== null, "Should return token");
    });
    
    client.log("âœ… Customer 1 logged in - Token saved");
%}

### 1.3 Register Customer 2 (For concurrent booking tests)
POST {{apiUrl}}/Authentication/register
Content-Type: application/json

{
  "username": "testbooking2",
  "email": "testbooking2@gmail.com",
  "password": "Booking@123",
  "fullName": "Tran Thi B",
  "phoneNumber": "0902345678",
  "identityCard": "001234567891",
  "address": "456 Le Loi, Q3, HCMC"
}

> {%
    client.global.set("customer2_token", response.body.data.token);
    client.global.set("customer2_id", response.body.data.accountId);
    
    client.log("âœ… Customer 2 registered - Token saved");
%}

### 1.4 Login as Admin
POST {{apiUrl}}/Authentication/login
Content-Type: application/json

{
  "email": "admin@hotel.com",
  "password": "Admin@123"
}

> {%
    client.global.set("admin_token", response.body.data.token);
    client.log("âœ… Admin logged in - Token saved");
%}

### ============================================
### SECTION 2: CHECK ROOM AVAILABILITY (DETAILED TESTS)
### ============================================

### 2.1 Check availability - Standard rooms (Based on seeding data)
# RoomTypeId 1 = "PhÃ²ng TiÃªu Chuáº©n" (STD) - 800,000 VNÄ/night
POST {{apiUrl}}/Booking/check-availability
Content-Type: application/json

{
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 2 }
  ],
  "checkInDate": "2025-11-05T14:00:00Z",
  "checkOutDate": "2025-11-07T12:00:00Z"
}

> {%
    client.test("Check availability - Response structure", function() {
        client.assert(response.status === 200 || response.status === 409, "Should return 200 or 409");
        client.assert(response.body.isSuccess === true, "Should be successful");
        client.assert(response.body.data !== null, "Should have data");
        client.assert(response.body.data.roomTypes !== null, "Should have roomTypes array");
        client.assert(response.body.data.totalNights === 2, "Should calculate 2 nights");
    });
    
    client.log("========================================");
    client.log("ğŸ“Š AVAILABILITY CHECK RESULT");
    client.log("========================================");
    client.log("ğŸ“… Check-in: 2025-11-05");
    client.log("ğŸ“… Check-out: 2025-11-07");
    client.log("ğŸŒ™ Total nights: " + response.body.data.totalNights);
    client.log("âœ… All available: " + response.body.data.isAllAvailable);
    client.log("ğŸ’¬ Message: " + response.body.data.message);
    client.log("");
    
    if (response.body.data && response.body.data.roomTypes) {
        response.body.data.roomTypes.forEach(function(rt) {
            client.log("ğŸ¨ " + rt.roomTypeName + " (" + rt.roomTypeCode + ")");
            client.log("   ğŸ“‹ Description: " + rt.description);
            client.log("   ğŸ’° Price/night: " + rt.basePriceNight.toLocaleString() + " VNÄ");
            client.log("   ğŸ‘¥ Max occupancy: " + rt.maxOccupancy + " ngÆ°á»i");
            client.log("   ğŸ“ Room size: " + rt.roomSize + "mÂ²");
            client.log("   ğŸ›ï¸  Beds: " + rt.numberOfBeds + " x " + rt.bedType);
            client.log("   ğŸ“Š Available: " + rt.availableCount + "/" + rt.requestedQuantity);
            client.log("   " + (rt.isAvailable ? "âœ…" : "âŒ") + " " + rt.message);
            client.log("   ğŸ–¼ï¸  Images: " + rt.images.length + " photos");
            client.log("");
        });
    }
    client.log("========================================");
%}

### 2.2 Check availability - Deluxe rooms
# RoomTypeId 2 = "PhÃ²ng Cao Cáº¥p" (DLX) - 1,500,000 VNÄ/night
POST {{apiUrl}}/Booking/check-availability
Content-Type: application/json

{
  "roomTypes": [
    { "roomTypeId": 2, "quantity": 1 }
  ],
  "checkInDate": "2025-11-10T14:00:00Z",
  "checkOutDate": "2025-11-13T12:00:00Z"
}

> {%
    client.test("Deluxe room check", function() {
        client.assert(response.body.data.totalNights === 3, "Should calculate 3 nights");
    });
    
    client.log("âœ… Deluxe room availability checked (3 nights)");
    if (response.body.data.roomTypes[0]) {
        var deluxe = response.body.data.roomTypes[0];
        client.log("   Price: " + deluxe.basePriceNight.toLocaleString() + " VNÄ/night");
        client.log("   Total estimate: " + (deluxe.basePriceNight * 3).toLocaleString() + " VNÄ");
    }
%}

### 2.3 Check availability - VIP rooms
# RoomTypeId 3 = "PhÃ²ng VIP" (VIP) - 2,500,000 VNÄ/night
POST {{apiUrl}}/Booking/check-availability
Content-Type: application/json

{
  "roomTypes": [
    { "roomTypeId": 3, "quantity": 1 }
  ],
  "checkInDate": "2025-11-15T14:00:00Z",
  "checkOutDate": "2025-11-17T12:00:00Z"
}

> {%
    client.log("âœ… VIP room availability checked");
%}

### 2.4 Check availability - Suite rooms
# RoomTypeId 4 = "Suite Sang Trá»ng" (SUT) - 4,000,000 VNÄ/night
POST {{apiUrl}}/Booking/check-availability
Content-Type: application/json

{
  "roomTypes": [
    { "roomTypeId": 4, "quantity": 1 }
  ],
  "checkInDate": "2025-11-20T14:00:00Z",
  "checkOutDate": "2025-11-23T12:00:00Z"
}

> {%
    client.log("âœ… Suite room availability checked");
    if (response.body.data.roomTypes[0]) {
        var suite = response.body.data.roomTypes[0];
        client.log("   Max occupancy: " + suite.maxOccupancy + " ngÆ°á»i");
        client.log("   Room size: " + suite.roomSize + "mÂ²");
    }
%}

### 2.5 Check availability - Mixed room types
# Test Ä‘áº·t nhiá»u loáº¡i phÃ²ng cÃ¹ng lÃºc
POST {{apiUrl}}/Booking/check-availability
Content-Type: application/json

{
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 2 },
    { "roomTypeId": 2, "quantity": 1 },
    { "roomTypeId": 3, "quantity": 1 }
  ],
  "checkInDate": "2025-12-01T14:00:00Z",
  "checkOutDate": "2025-12-05T12:00:00Z"
}

> {%
    client.test("Mixed room types check", function() {
        client.assert(response.body.data.roomTypes.length === 3, "Should check 3 room types");
    });
    
    client.log("========================================");
    client.log("ğŸ“Š MIXED ROOM TYPES CHECK");
    client.log("========================================");
    var totalEstimate = 0;
    response.body.data.roomTypes.forEach(function(rt) {
        var estimate = rt.basePriceNight * rt.requestedQuantity * response.body.data.totalNights;
        totalEstimate += estimate;
        client.log(rt.roomTypeName + ": " + rt.requestedQuantity + " phÃ²ng x " + 
                   response.body.data.totalNights + " nights = " + estimate.toLocaleString() + " VNÄ");
    });
    client.log("ğŸ’° Total estimate: " + totalEstimate.toLocaleString() + " VNÄ");
    client.log("ğŸ’µ Deposit (30%): " + (totalEstimate * 0.3).toLocaleString() + " VNÄ");
    client.log("========================================");
%}

### 2.6 Check availability - Overbooking test
# Test yÃªu cáº§u nhiá»u phÃ²ng hÆ¡n sá»‘ lÆ°á»£ng cÃ³
POST {{apiUrl}}/Booking/check-availability
Content-Type: application/json

{
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 100 }
  ],
  "checkInDate": "2025-11-05T14:00:00Z",
  "checkOutDate": "2025-11-07T12:00:00Z"
}

> {%
    client.test("Overbooking check", function() {
        if (response.body.data && response.body.data.roomTypes[0]) {
            client.assert(response.body.data.roomTypes[0].isAvailable === false, 
                "Should not have 100 rooms available");
        }
    });
    
    client.log("âš ï¸ Overbooking test - Expected: Not enough rooms");
    if (response.body.data.roomTypes[0]) {
        client.log("   Available: " + response.body.data.roomTypes[0].availableCount);
        client.log("   Requested: " + response.body.data.roomTypes[0].requestedQuantity);
    }
%}

### ============================================
### SECTION 3: CREATE BOOKING (Authenticated User)
### ============================================

### 3.1 Create booking - 2 Standard rooms (MAIN TEST)
# Test Ä‘áº§y Ä‘á»§ response vÃ  queue processing
POST {{apiUrl}}/Booking
Content-Type: application/json
Authorization: Bearer {{customer1_token}}

{
  "customerId": 4,
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 2 }
  ],
  "checkInDate": "2025-11-05T14:00:00Z",
  "checkOutDate": "2025-11-07T12:00:00Z",
  "specialRequests": "Non-smoking rooms, early check-in if possible"
}

> {%
    if (response.body.data && response.body.data.bookingId) {
        client.global.set("booking_id_1", response.body.data.bookingId);
        client.global.set("payment_url_1", response.body.data.paymentUrl);
        client.global.set("room_ids_1", JSON.stringify(response.body.data.roomIds));
    }
    
    client.test("Create booking - Full validation", function() {
        client.assert(response.status === 201, "Status should be 201 Created");
        client.assert(response.body.isSuccess === true, "Should be successful");
        client.assert(response.body.statusCode === 201, "StatusCode should be 201");
        client.assert(response.body.message !== null, "Should have message");
        
        // Validate data structure
        var data = response.body.data;
        client.assert(data !== null, "Should have data");
        client.assert(data.bookingId > 0, "Should have valid booking ID");
        client.assert(data.customerId > 0, "Should have customer ID");
        client.assert(data.customerName !== "", "Should have customer name");
        client.assert(data.roomIds.length === 2, "Should have 2 rooms");
        client.assert(data.roomNames.length === 2, "Should have 2 room names");
        client.assert(data.totalAmount > 0, "Should have total amount");
        client.assert(data.depositAmount > 0, "Should have deposit amount");
        client.assert(data.depositAmount === data.totalAmount * 0.3, "Deposit should be 30%");
        client.assert(data.paymentUrl !== null, "Should have payment URL");
        client.assert(data.paymentUrl.includes("payos"), "Payment URL should be PayOS");
        client.assert(data.roomTypeDetails.length > 0, "Should have room type details");
    });
    
    if (response.body.data) {
        client.log("========================================");
        client.log("âœ… BOOKING CREATED SUCCESSFULLY");
        client.log("========================================");
        client.log("ğŸ“‹ Booking ID: " + response.body.data.bookingId);
        client.log("ğŸ‘¤ Customer: " + response.body.data.customerName + " (ID: " + response.body.data.customerId + ")");
        client.log("");
        client.log("ğŸ¨ ROOMS BOOKED:");
        response.body.data.roomNames.forEach(function(name, index) {
            client.log("   " + (index + 1) + ". " + name + " (ID: " + response.body.data.roomIds[index] + ")");
        });
        client.log("");
        client.log("ğŸ“… Check-in: " + new Date(response.body.data.checkInDate).toLocaleString());
        client.log("ğŸ“… Check-out: " + new Date(response.body.data.checkOutDate).toLocaleString());
        client.log("");
        client.log("ğŸ’° PRICING:");
        response.body.data.roomTypeDetails.forEach(function(rt) {
            var nights = 2; // From the dates above
            var subtotal = rt.pricePerNight * rt.quantity * nights;
            client.log("   " + rt.roomTypeName + " (" + rt.roomTypeCode + "):");
            client.log("     " + rt.quantity + " phÃ²ng x " + rt.pricePerNight.toLocaleString() + " VNÄ x " + nights + " nights");
            client.log("     = " + subtotal.toLocaleString() + " VNÄ");
        });
        client.log("");
        client.log("ğŸ’° Total Amount: " + response.body.data.totalAmount.toLocaleString() + " VNÄ");
        client.log("ğŸ’µ Deposit (30%): " + response.body.data.depositAmount.toLocaleString() + " VNÄ");
        client.log("ğŸ’µ Remaining: " + (response.body.data.totalAmount - response.body.data.depositAmount).toLocaleString() + " VNÄ");
        client.log("");
        client.log("ğŸ’³ Payment URL: " + response.body.data.paymentUrl);
        client.log("");
        client.log("â° IMPORTANT NOTES:");
        client.log("   âš ï¸  Pay within 15 minutes or booking will be auto-cancelled!");
        client.log("   ğŸ”’ Rooms are locked in cache for payment");
        client.log("   ğŸ“¨ Confirmation email will be sent after payment");
        client.log("   ğŸ« Queue message created for background processing");
        client.log("========================================");
    } else {
        client.log("âŒ Failed to create booking");
        client.log("Message: " + response.body.message);
    }
%}

### 3.2 Create booking - 1 Deluxe room (Long stay)
POST {{apiUrl}}/Booking
Content-Type: application/json
Authorization: Bearer {{customer1_token}}

{
  "customerId": 4,
  "roomTypes": [
    { "roomTypeId": 2, "quantity": 1 }
  ],
  "checkInDate": "2025-11-10T14:00:00Z",
  "checkOutDate": "2025-11-17T12:00:00Z",
  "specialRequests": "Business trip - need quiet room with strong wifi"
}

> {%
    client.global.set("booking_id_2", response.body.data.bookingId);
    
    client.test("Deluxe booking created", function() {
        client.assert(response.status === 201, "Should create successfully");
    });
    
    client.log("âœ… Deluxe room booking created (7 nights)");
    client.log("   Booking ID: " + response.body.data.bookingId);
    client.log("   Total: " + response.body.data.totalAmount.toLocaleString() + " VNÄ");
    client.log("   Deposit: " + response.body.data.depositAmount.toLocaleString() + " VNÄ");
%}

### 3.3 Create booking - Multiple room types (Family booking)
POST {{apiUrl}}/Booking
Content-Type: application/json
Authorization: Bearer {{customer1_token}}

{
  "customerId": 4,
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 2 },
    { "roomTypeId": 3, "quantity": 1 }
  ],
  "checkInDate": "2025-12-01T14:00:00Z",
  "checkOutDate": "2025-12-05T12:00:00Z",
  "specialRequests": "Family with kids - need connecting rooms or close together"
}

> {%
    if (response.body.data && response.body.data.bookingId) {
        client.global.set("booking_id_3", response.body.data.bookingId);
    }
    
    client.test("Family booking created", function() {
        client.assert(response.status === 201, "Should create successfully");
        if (response.body.data) {
            client.assert(response.body.data.roomIds.length === 3, "Should have 3 rooms");
            client.assert(response.body.data.roomTypeDetails.length === 2, "Should have 2 room types");
        }
    });
    
    if (response.body.data) {
        client.log("âœ… Family booking created (3 rooms, 2 types)");
        client.log("   Room types: 2x Standard + 1x VIP");
        client.log("   Total: " + response.body.data.totalAmount.toLocaleString() + " VNÄ");
    }
%}

### 3.4 Create booking - VIP Suite for honeymoon
POST {{apiUrl}}/Booking
Content-Type: application/json
Authorization: Bearer {{customer1_token}}

{
  "customerId": 4,
  "roomTypes": [
    { "roomTypeId": 4, "quantity": 1 }
  ],
  "checkInDate": "2025-12-20T14:00:00Z",
  "checkOutDate": "2025-12-25T12:00:00Z",
  "specialRequests": "Honeymoon - please prepare romantic decoration, flowers and champagne"
}

> {%
    client.global.set("booking_id_4", response.body.data.bookingId);
    
    client.log("âœ… Suite honeymoon booking created (5 nights)");
    client.log("   Total: " + response.body.data.totalAmount.toLocaleString() + " VNÄ");
%}

### ============================================
### SECTION 4: GUEST BOOKING (No Authentication)
### ============================================

### 4.1 Guest Booking - First time guest (Auto-create customer)
POST {{apiUrl}}/Booking/guest
Content-Type: application/json

{
  "fullName": "Pham Van Guest",
  "email": "guest.test.new@example.com",
  "phoneNumber": "0911111111",
  "identityCard": "079111111111",
  "address": "789 Tran Hung Dao, Q5, HCMC",
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 1 }
  ],
  "checkInDate": "2025-11-08T14:00:00Z",
  "checkOutDate": "2025-11-10T12:00:00Z",
  "specialRequests": "First time booking, please call before check-in"
}

> {%
    client.global.set("guest_booking_id", response.body.data.bookingId);
    client.global.set("guest_customer_id", response.body.data.customerId);
    
    client.test("Guest booking - Full validation", function() {
        client.assert(response.status === 201, "Should create successfully");
        client.assert(response.body.data.customerId > 0, "Should auto-create customer");
        client.assert(response.body.data.customerName === "Pham Van Guest", "Should have correct name");
        client.assert(response.body.data.paymentUrl !== null, "Should have payment URL");
    });
    
    client.log("========================================");
    client.log("âœ… GUEST BOOKING CREATED");
    client.log("========================================");
    client.log("ğŸ“‹ Booking ID: " + response.body.data.bookingId);
    client.log("ğŸ‘¤ Customer ID: " + response.body.data.customerId + " (auto-created)");
    client.log("ğŸ“§ Email: guest.test.new@example.com");
    client.log("ğŸ” Default password: 123456 (sent via email)");
    client.log("ğŸ“± Phone: 0911111111");
    client.log("");
    client.log("ğŸ’° Total: " + response.body.data.totalAmount.toLocaleString() + " VNÄ");
    client.log("ğŸ’µ Deposit: " + response.body.data.depositAmount.toLocaleString() + " VNÄ");
    client.log("");
    client.log("ğŸ’³ Payment URL: " + response.body.data.paymentUrl);
    client.log("========================================");
%}

### 4.2 Guest Booking - Returning guest (Reuse existing customer)
# Sá»­ dá»¥ng cÃ¹ng email/phone sáº½ tÃ¬m vÃ  cáº­p nháº­t customer cÅ©
POST {{apiUrl}}/Booking/guest
Content-Type: application/json

{
  "fullName": "Pham Van Guest",
  "email": "guest.test.new@example.com",
  "phoneNumber": "0911111111",
  "identityCard": "079111111111",
  "address": "789 Tran Hung Dao, Q5, HCMC - Updated",
  "roomTypes": [
    { "roomTypeId": 2, "quantity": 1 }
  ],
  "checkInDate": "2025-11-15T14:00:00Z",
  "checkOutDate": "2025-11-18T12:00:00Z",
  "specialRequests": "Returning customer - updated address"
}

> {%
    client.test("Returning guest booking", function() {
        client.assert(response.status === 201, "Should create successfully");
        if (client.global.get("guest_customer_id")) {
            client.assert(response.body.data.customerId == client.global.get("guest_customer_id"), 
                "Should reuse existing customer ID");
        }
    });
    
    client.log("âœ… Returning guest booking - Customer reused");
    client.log("   Customer ID: " + response.body.data.customerId);
    client.log("   Booking ID: " + response.body.data.bookingId);
%}

### 4.3 Guest Booking - Group booking (Multiple room types)
POST {{apiUrl}}/Booking/guest
Content-Type: application/json

{
  "fullName": "Le Thi Group Leader",
  "email": "group.booking@company.com",
  "phoneNumber": "0922222222",
  "identityCard": "079222222222",
  "address": "456 Vo Van Tan, Q3, HCMC",
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 3 },
    { "roomTypeId": 2, "quantity": 2 }
  ],
  "checkInDate": "2025-12-10T14:00:00Z",
  "checkOutDate": "2025-12-13T12:00:00Z",
  "specialRequests": "Corporate group booking - 5 rooms on same floor if possible"
}

> {%
    client.test("Group booking", function() {
        client.assert(response.status === 201, "Should create successfully");
        client.assert(response.body.data.roomIds.length === 5, "Should have 5 rooms");
    });
    
    client.log("âœ… Group booking created (5 rooms)");
    client.log("   Total: " + response.body.data.totalAmount.toLocaleString() + " VNÄ");
%}

### ============================================
### SECTION 5: GET BOOKING DETAILS & LIST
### ============================================

### 5.1 Get booking by ID - Detailed validation
GET {{apiUrl}}/Booking/{{booking_id_1}}
Authorization: Bearer {{customer1_token}}

> {%
    client.test("Get booking details - Full validation", function() {
        client.assert(response.status === 200, "Status should be 200");
        client.assert(response.body.isSuccess === true, "Should be successful");
        
        var data = response.body.data;
        client.assert(data.bookingId > 0, "Should have booking ID");
        client.assert(data.customerId > 0, "Should have customer ID");
        client.assert(data.customerName !== "", "Should have customer name");
        client.assert(data.roomIds.length > 0, "Should have room IDs");
        client.assert(data.roomNames.length > 0, "Should have room names");
        client.assert(data.totalAmount > 0, "Should have total amount");
        client.assert(data.depositAmount > 0, "Should have deposit amount");
        client.assert(data.paymentStatus !== "", "Should have payment status");
        client.assert(data.depositStatus !== "", "Should have deposit status");
        client.assert(data.bookingType !== "", "Should have booking type");
        client.assert(data.checkInDate !== null, "Should have check-in date");
        client.assert(data.checkOutDate !== null, "Should have check-out date");
    });
    
    if (response.body.data) {
        client.log("========================================");
        client.log("ğŸ“‹ BOOKING DETAILS");
        client.log("========================================");
        client.log("ID: " + response.body.data.bookingId);
        client.log("Customer: " + response.body.data.customerName + " (ID: " + response.body.data.customerId + ")");
        client.log("");
        client.log("Rooms: " + response.body.data.roomNames.join(", "));
        client.log("Check-in: " + new Date(response.body.data.checkInDate).toLocaleString());
        client.log("Check-out: " + new Date(response.body.data.checkOutDate).toLocaleString());
        client.log("");
        client.log("Total: " + response.body.data.totalAmount.toLocaleString() + " VNÄ");
        client.log("Deposit: " + response.body.data.depositAmount.toLocaleString() + " VNÄ");
        client.log("");
        client.log("Payment Status: " + response.body.data.paymentStatus);
        client.log("Deposit Status: " + response.body.data.depositStatus);
        client.log("Booking Type: " + response.body.data.bookingType);
        client.log("");
        if (response.body.data.specialRequests) {
            client.log("Special Requests: " + response.body.data.specialRequests);
        }
        client.log("Created At: " + new Date(response.body.data.createdAt).toLocaleString());
        client.log("========================================");
    }
%}

### 5.2 Get all my bookings
GET {{apiUrl}}/Booking/my-bookings
Authorization: Bearer {{customer1_token}}

> {%
    client.test("Get my bookings - Validation", function() {
        client.assert(response.status === 200, "Status should be 200");
        client.assert(response.body.isSuccess === true, "Should be successful");
        client.assert(Array.isArray(response.body.data), "Should return array");
    });
    
    client.log("========================================");
    client.log("ğŸ“‹ MY BOOKINGS LIST");
    client.log("========================================");
    client.log("Total bookings: " + response.body.data.length);
    client.log("");
    
    if (response.body.data && response.body.data.length > 0) {
        response.body.data.forEach(function(booking, index) {
            client.log((index + 1) + ". Booking #" + booking.bookingId);
            client.log("   Rooms: " + booking.roomNames.join(", "));
            client.log("   Check-in: " + new Date(booking.checkInDate).toLocaleDateString());
            client.log("   Total: " + booking.totalAmount.toLocaleString() + " VNÄ");
            client.log("   Payment: " + booking.paymentStatus);
            client.log("   Deposit: " + booking.depositStatus);
            client.log("");
        });
    }
    client.log("========================================");
%}

### ============================================
### SECTION 6: CANCEL BOOKING & QUEUE PROCESSING
### ============================================

### 6.1 Cancel booking - Test queue message
DELETE {{apiUrl}}/Booking/{{booking_id_2}}
Authorization: Bearer {{customer1_token}}

> {%
    client.test("Cancel booking - Validation", function() {
        client.assert(response.status === 200, "Should cancel successfully");
        client.assert(response.body.isSuccess === true, "Should be successful");
        client.assert(response.body.message !== null, "Should have message");
    });
    
    client.log("========================================");
    client.log("âœ… BOOKING CANCELLED");
    client.log("========================================");
    client.log("ğŸ“‹ Booking ID: " + client.global.get("booking_id_2"));
    client.log("ğŸ’¬ Message: " + response.body.message);
    client.log("");
    client.log("ğŸ« QUEUE PROCESSING:");
    client.log("   âœ“ Cancel message enqueued");
    client.log("   âœ“ Room locks will be released");
    client.log("   âœ“ Payment cache will be cleared");
    client.log("   âœ“ Booking record will be deleted");
    client.log("========================================");
%}

### 6.2 Verify cancelled booking
GET {{apiUrl}}/Booking/{{booking_id_2}}
Authorization: Bearer {{customer1_token}}

> {%
    client.test("Cancelled booking should not exist", function() {
        // After queue processing, booking should be deleted
        // May return 404 or still exist if queue not processed yet
        if (response.status === 404) {
            client.log("âœ… Booking deleted by queue processor");
        } else if (response.status === 200) {
            client.log("â³ Booking still exists - Queue not processed yet");
        }
    });
%}

### 6.3 Cancel another booking for testing
DELETE {{apiUrl}}/Booking/{{booking_id_4}}
Authorization: Bearer {{customer1_token}}

> {%
    client.log("âœ… Another booking cancelled - Queue message sent");
%}

### ============================================
### SECTION 7: CONCURRENT BOOKING TEST (Cache Locking)
### ============================================

### 7.1 Concurrent Test - Customer 1 Request
# Cháº¡y Ä‘á»“ng thá»i vá»›i 7.2 Ä‘á»ƒ test cache locking
POST {{apiUrl}}/Booking
Content-Type: application/json
Authorization: Bearer {{customer1_token}}

{
  "customerId": 4,
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 2 }
  ],
  "checkInDate": "2026-01-10T14:00:00Z",
  "checkOutDate": "2026-01-12T12:00:00Z",
  "specialRequests": "Concurrent test - Customer 1"
}

> {%
    client.test("Concurrent booking - Customer 1", function() {
        if (response.status === 201) {
            client.log("âœ… Customer 1 - SUCCESS (acquired locks)");
            client.log("   Booking ID: " + response.body.data.bookingId);
            client.log("   Rooms locked: " + response.body.data.roomIds.join(", "));
        } else if (response.status === 409) {
            client.log("âŒ Customer 1 - CONFLICT (rooms already locked)");
            client.log("   Message: " + response.body.message);
        }
    });
%}

### 7.2 Concurrent Test - Customer 2 Request
# Cháº¡y ngay sau 7.1 (trong vÃ i giÃ¢y)
POST {{apiUrl}}/Booking
Content-Type: application/json
Authorization: Bearer {{customer2_token}}

{
  "customerId": 5,
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 2 }
  ],
  "checkInDate": "2026-01-10T14:00:00Z",
  "checkOutDate": "2026-01-12T12:00:00Z",
  "specialRequests": "Concurrent test - Customer 2"
}

> {%
    client.test("Concurrent booking - Customer 2", function() {
        if (response.status === 201) {
            client.log("âœ… Customer 2 - SUCCESS (acquired locks)");
            client.log("   Booking ID: " + response.body.data.bookingId);
        } else if (response.status === 409) {
            client.log("âŒ Customer 2 - CONFLICT (rooms already locked)");
            client.log("   Message: " + response.body.message);
        }
    });
    
    client.log("");
    client.log("========================================");
    client.log("ğŸ”’ CACHE LOCKING TEST RESULT");
    client.log("========================================");
    client.log("Expected: One SUCCESS, one CONFLICT");
    client.log("This proves cache locking is working correctly!");
    client.log("========================================");
%}

### ============================================
### SECTION 8: ERROR SCENARIOS & EDGE CASES
### ============================================

### 8.1 Create booking without authentication
POST {{apiUrl}}/Booking
Content-Type: application/json

{
  "customerId": 1,
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 1 }
  ],
  "checkInDate": "2025-11-05T14:00:00Z",
  "checkOutDate": "2025-11-07T12:00:00Z"
}

> {%
    client.test("Should require authentication", function() {
        client.assert(response.status === 401, "Status should be 401 Unauthorized");
    });
    client.log("âœ… Correctly rejected - No authentication");
%}

### 8.2 Create booking with invalid customer ID
POST {{apiUrl}}/Booking
Content-Type: application/json
Authorization: Bearer {{customer1_token}}

{
  "customerId": 99999,
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 1 }
  ],
  "checkInDate": "2025-11-05T14:00:00Z",
  "checkOutDate": "2025-11-07T12:00:00Z"
}

> {%
    client.test("Should return not found", function() {
        client.assert(response.status === 404, "Status should be 404 Not Found");
    });
    client.log("âœ… Correctly rejected - Invalid customer ID");
%}

### 8.3 Create booking with invalid room type
POST {{apiUrl}}/Booking
Content-Type: application/json
Authorization: Bearer {{customer1_token}}

{
  "customerId": 4,
  "roomTypes": [
    { "roomTypeId": 999, "quantity": 1 }
  ],
  "checkInDate": "2025-11-05T14:00:00Z",
  "checkOutDate": "2025-11-07T12:00:00Z"
}

> {%
    client.test("Should return not found", function() {
        client.assert(response.status === 404, "Status should be 404 Not Found");
        client.assert(response.body.message.includes("Loáº¡i phÃ²ng"), "Should mention room type");
    });
    client.log("âœ… Correctly rejected - Invalid room type ID");
%}

### 8.4 Create booking with past check-in date
POST {{apiUrl}}/Booking
Content-Type: application/json
Authorization: Bearer {{customer1_token}}

{
  "customerId": 4,
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 1 }
  ],
  "checkInDate": "2020-01-01T14:00:00Z",
  "checkOutDate": "2020-01-03T12:00:00Z"
}

> {%
    client.test("Should reject past dates", function() {
        client.assert(response.status === 400, "Status should be 400 Bad Request");
    });
    client.log("âœ… Correctly rejected - Past check-in date");
%}

### 8.5 Create booking with checkout before checkin
POST {{apiUrl}}/Booking
Content-Type: application/json
Authorization: Bearer {{customer1_token}}

{
  "customerId": 4,
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 1 }
  ],
  "checkInDate": "2025-11-10T14:00:00Z",
  "checkOutDate": "2025-11-05T12:00:00Z"
}

> {%
    client.test("Should reject invalid date range", function() {
        client.assert(response.status === 400, "Status should be 400 Bad Request");
    });
    client.log("âœ… Correctly rejected - Check-out before check-in");
%}

### 8.6 Create booking with empty room types
POST {{apiUrl}}/Booking
Content-Type: application/json
Authorization: Bearer {{customer1_token}}

{
  "customerId": 4,
  "roomTypes": [],
  "checkInDate": "2025-11-05T14:00:00Z",
  "checkOutDate": "2025-11-07T12:00:00Z"
}

> {%
    client.test("Should require room types", function() {
        client.assert(response.status === 400, "Status should be 400 Bad Request");
    });
    client.log("âœ… Correctly rejected - Empty room types");
%}

### 8.7 Create booking requesting more rooms than available
POST {{apiUrl}}/Booking
Content-Type: application/json
Authorization: Bearer {{customer1_token}}

{
  "customerId": 4,
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 100 }
  ],
  "checkInDate": "2025-11-05T14:00:00Z",
  "checkOutDate": "2025-11-07T12:00:00Z"
}

> {%
    client.test("Should return conflict", function() {
        client.assert(response.status === 409, "Status should be 409 Conflict");
        client.assert(response.body.message.includes("KhÃ´ng Ä‘á»§ phÃ²ng"), "Should mention not enough rooms");
    });
    client.log("âœ… Correctly rejected - Not enough rooms available");
%}

### 8.8 Guest booking with missing email
POST {{apiUrl}}/Booking/guest
Content-Type: application/json

{
  "fullName": "Test User",
  "phoneNumber": "0123456789",
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 1 }
  ],
  "checkInDate": "2025-11-05T14:00:00Z",
  "checkOutDate": "2025-11-07T12:00:00Z"
}

> {%
    client.test("Should require email", function() {
        client.assert(response.status === 400, "Status should be 400 Bad Request");
    });
    client.log("âœ… Correctly rejected - Missing email");
%}

### 8.9 Guest booking with missing phone number
POST {{apiUrl}}/Booking/guest
Content-Type: application/json

{
  "fullName": "Test User",
  "email": "test@example.com",
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 1 }
  ],
  "checkInDate": "2025-11-05T14:00:00Z",
  "checkOutDate": "2025-11-07T12:00:00Z"
}

> {%
    client.test("Should require phone number", function() {
        client.assert(response.status === 400, "Status should be 400 Bad Request");
    });
    client.log("âœ… Correctly rejected - Missing phone number");
%}

### 8.10 Guest booking with missing full name
POST {{apiUrl}}/Booking/guest
Content-Type: application/json

{
  "email": "test@example.com",
  "phoneNumber": "0123456789",
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 1 }
  ],
  "checkInDate": "2025-11-05T14:00:00Z",
  "checkOutDate": "2025-11-07T12:00:00Z"
}

> {%
    client.test("Should require full name", function() {
        client.assert(response.status === 400, "Status should be 400 Bad Request");
    });
    client.log("âœ… Correctly rejected - Missing full name");
%}

### 8.11 Get non-existent booking
GET {{apiUrl}}/Booking/99999
Authorization: Bearer {{customer1_token}}

> {%
    client.test("Should return not found", function() {
        client.assert(response.status === 404, "Status should be 404 Not Found");
    });
    client.log("âœ… Correctly returned 404 - Booking not found");
%}

### ============================================
### SECTION 9: QUEUE & BACKGROUND PROCESSING TESTS
### ============================================

### 9.1 Create booking and check queue processing
# Táº¡o booking vÃ  Ä‘á»£i queue xá»­ lÃ½
POST {{apiUrl}}/Booking
Content-Type: application/json
Authorization: Bearer {{customer1_token}}

{
  "customerId": 4,
  "roomTypes": [
    { "roomTypeId": 1, "quantity": 1 }
  ],
  "checkInDate": "2026-02-01T14:00:00Z",
  "checkOutDate": "2026-02-03T12:00:00Z",
  "specialRequests": "Queue processing test"
}

> {%
    client.global.set("queue_test_booking_id", response.body.data.bookingId);
    client.global.set("queue_test_room_ids", JSON.stringify(response.body.data.roomIds));
    
    client.log("========================================");
    client.log("ğŸ« QUEUE PROCESSING TEST");
    client.log("========================================");
    client.log("âœ… Booking created: #" + response.body.data.bookingId);
    client.log("");
    client.log("ğŸ“¨ Queue messages that should be processed:");
    client.log("   1. CreateBooking - Verify room locks");
    client.log("   2. Auto-cancel after 15 minutes (if not paid)");
    client.log("");
    client.log("ğŸ” To verify queue processing:");
    client.log("   - Check application logs for BookingQueueProcessor");
    client.log("   - Verify room locks in cache");
    client.log("   - Wait 15 minutes to see auto-cancel");
    client.log("========================================");
%}

### 9.2 Simulate auto-cancel timeout (Manual test)
# Sau 15 phÃºt, booking sáº½ tá»± Ä‘á»™ng bá»‹ há»§y náº¿u chÆ°a thanh toÃ¡n
# Kiá»ƒm tra láº¡i booking sau 15 phÃºt
GET {{apiUrl}}/Booking/{{queue_test_booking_id}}
Authorization: Bearer {{customer1_token}}

> {%
    if (response.status === 404) {
        client.log("âœ… Auto-cancel worked - Booking deleted after timeout");
    } else if (response.status === 200) {
        client.log("â³ Booking still exists");
        if (response.body.data) {
            client.log("   Payment status: " + response.body.data.paymentStatus);
            client.log("   Deposit status: " + response.body.data.depositStatus);
        }
    }
%}

### ============================================
### SECTION 10: PAYMENT SCENARIOS
### ============================================

### 10.1 Simulate payment confirmation
# ThÆ°á»ng Ä‘Æ°á»£c gá»i tá»« PayOS webhook, nhÆ°ng cÃ³ thá»ƒ test manual
POST {{apiUrl}}/Booking/confirm-payment
Content-Type: application/json

{
  "bookingId": {{booking_id_1}},
  "orderCode": "251031120000",
  "status": "PAID"
}

> {%
    client.test("Payment confirmation", function() {
        // May fail if payment info not in cache or already processed
        if (response.status === 200) {
            client.log("âœ… Payment confirmed successfully");
        } else if (response.status === 404) {
            client.log("âš ï¸  Payment info not found in cache (may be expired)");
        } else if (response.status === 400) {
            client.log("âš ï¸  Payment not completed or invalid order code");
        }
    });
%}

### 10.2 Check booking after payment
GET {{apiUrl}}/Booking/{{booking_id_1}}
Authorization: Bearer {{customer1_token}}

> {%
    if (response.body.data) {
        client.log("========================================");
        client.log("ğŸ’³ PAYMENT STATUS CHECK");
        client.log("========================================");
        client.log("Booking ID: " + response.body.data.bookingId);
        client.log("Payment Status: " + response.body.data.paymentStatus);
        client.log("Deposit Status: " + response.body.data.depositStatus);
        client.log("");
        if (response.body.data.depositStatus === "ÄÃ£ Ä‘áº·t cá»c") {
            client.log("âœ… Payment confirmed!");
            client.log("ğŸ”“ Room locks released");
            client.log("ğŸ“§ Confirmation email sent");
        } else {
            client.log("â³ Payment pending");
        }
        client.log("========================================");
    }
%}

### ============================================
### TESTING SUMMARY & DOCUMENTATION
### ============================================
# 
# ğŸ“ COMPREHENSIVE TEST COVERAGE:
# 
# âœ… SECTION 1: Authentication (4 tests)
#    - Register customer 1 & 2
#    - Login customers
#    - Login admin
# 
# âœ… SECTION 2: Check Availability (6 tests)
#    - Standard rooms (detailed validation)
#    - Deluxe rooms
#    - VIP rooms
#    - Suite rooms
#    - Mixed room types
#    - Overbooking scenario
# 
# âœ… SECTION 3: Create Booking - Authenticated (4 tests)
#    - Standard rooms with full validation
#    - Deluxe long stay
#    - Family booking (multiple types)
#    - Honeymoon suite
# 
# âœ… SECTION 4: Guest Booking (3 tests)
#    - First time guest (auto-create customer)
#    - Returning guest (reuse customer)
#    - Group booking
# 
# âœ… SECTION 5: Get Booking Details (2 tests)
#    - Get by ID with full validation
#    - Get my bookings list
# 
# âœ… SECTION 6: Cancel Booking (3 tests)
#    - Cancel with queue message
#    - Verify cancellation
#    - Additional cancel test
# 
# âœ… SECTION 7: Concurrent Booking (2 tests)
#    - Test cache locking mechanism
#    - Verify conflict resolution
# 
# âœ… SECTION 8: Error Scenarios (11 tests)
#    - No authentication
#    - Invalid customer ID
#    - Invalid room type
#    - Past dates
#    - Invalid date range
#    - Empty room types
#    - Insufficient rooms
#    - Missing email/phone/name
#    - Non-existent booking
# 
# âœ… SECTION 9: Queue Processing (2 tests)
#    - Create booking queue message
#    - Auto-cancel timeout
# 
# âœ… SECTION 10: Payment (2 tests)
#    - Payment confirmation
#    - Post-payment status check
# 
# ğŸ¯ KEY FEATURES TESTED:
# âœ“ Room availability checking with detailed response
# âœ“ Booking creation (authenticated & guest)
# âœ“ Cache locking mechanism (concurrent requests)
# âœ“ Queue message processing
# âœ“ Auto-cancel after 15 minutes
# âœ“ Payment integration (PayOS)
# âœ“ Customer auto-creation for guests
# âœ“ Multiple room types in one booking
# âœ“ Response validation (structure, data, status codes)
# âœ“ Error handling and edge cases
# 
# ğŸ“Š BASED ON SEEDING DATA:
# - RoomType 1: PhÃ²ng TiÃªu Chuáº©n (STD) - 800,000 VNÄ
# - RoomType 2: PhÃ²ng Cao Cáº¥p (DLX) - 1,500,000 VNÄ
# - RoomType 3: PhÃ²ng VIP (VIP) - 2,500,000 VNÄ
# - RoomType 4: Suite Sang Trá»ng (SUT) - 4,000,000 VNÄ
# 
# ğŸ”§ HOW TO USE:
# 1. Run Section 1 first (authentication)
# 2. Run any section independently
# 3. Check detailed logs in each response
# 4. Verify queue processing in application logs
# 
# âš ï¸ NOTES:
# - Change customerId from 4 to your actual customer ID
# - Adjust dates to future dates as needed
# - Some tests depend on previous tests (variables)
# - Queue processing is asynchronous
# 
# ============================================

