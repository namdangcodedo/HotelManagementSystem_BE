### Booking API Tests
### Variables
@baseUrl = http://localhost:8080
@apiUrl = {{baseUrl}}/api
@access_token = YOUR_JWT_TOKEN_HERE

###############################################
### 0. LOGIN TO GET TOKEN (Do this first!)
###############################################

### Login as admin
POST {{apiUrl}}/Authentication/login
Content-Type: application/json

{
  "email": "admin",
  "password": "Admin@123"
}

### Login with admin email (also works)
POST {{apiUrl}}/Authentication/login
Content-Type: application/json

{
  "email": "admin@hotel.com",
  "password": "Admin@123"
}

### Login as manager
POST {{apiUrl}}/Authentication/login
Content-Type: application/json

{
  "email": "manager",
  "password": "Manager@123"
}

### Login as receptionist (staff account)
POST {{apiUrl}}/Authentication/login
Content-Type: application/json

{
  "email": "receptionist",
  "password": "Staff@123"
}

### Register a new customer account (then use this to login)
POST {{apiUrl}}/Authentication/register
Content-Type: application/json

{
  "username": "customer1",
  "email": "customer1@gmail.com",
  "password": "Customer@123",
  "fullName": "Nguyen Van Khach",
  "phoneNumber": "0912345678",
  "identityCard": "001234567890",
  "address": "123 Nguyen Hue, Q1, HCM"
}

# üëâ After registering, copy the "token" from response and paste it to @access_token variable above
# üëâ OR login with the registered account using email/username and password

###############################################
### 1. CHECK ROOM AVAILABILITY
###############################################

### Check availability for specific room types and dates
POST {{apiUrl}}/Booking/check-availability
Content-Type: application/json

{
  "roomTypeQuantities": {
    "1": 2,
    "2": 1
  },
  "checkInDate": "2025-10-25T14:00:00Z",
  "checkOutDate": "2025-10-27T12:00:00Z"
}

###############################################
### 2. CREATE BOOKING (Authenticated User)
###############################################

### ‚ö†Ô∏è Important: You need to register a customer account first (see section 0)
### Then get the CustomerId from the registration response

### Create booking for authenticated customer
POST {{apiUrl}}/Booking
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "customerId": 1,
  "roomTypeQuantities": {
    "1": 2,
    "3": 1
  },
  "checkInDate": "2025-10-25T14:00:00Z",
  "checkOutDate": "2025-10-27T12:00:00Z",
  "specialRequests": "Early check-in if possible, non-smoking rooms",
  "bookingType": "Online"
}

###############################################
### 3. CREATE GUEST BOOKING (No Authentication)
###############################################

### ‚úÖ Recommended: Use this for testing without account registration
### Create booking for guest (no login required)
POST {{apiUrl}}/Booking/guest
Content-Type: application/json

{
  "fullName": "Nguyen Van A",
  "email": "nguyenvana@gmail.com",
  "phoneNumber": "0901234567",
  "identityCard": "001234567890",
  "address": "123 Nguyen Hue, Q1, HCM",
  "roomTypeQuantities": {
    "1": 1,
    "2": 1
  },
  "checkInDate": "2025-10-26T14:00:00Z",
  "checkOutDate": "2025-10-28T12:00:00Z",
  "specialRequests": "Late check-out if available",
  "bookingType": "Online"
}

###############################################
### 4. GET BOOKING BY ID
###############################################

### Get booking details
GET {{apiUrl}}/Booking/1
Authorization: Bearer {{access_token}}

###############################################
### 5. CONFIRM PAYMENT (PayOS Callback)
###############################################

### Confirm payment after PayOS transaction
POST {{apiUrl}}/Booking/confirm-payment
Content-Type: application/json

{
  "bookingId": 1,
  "orderCode": "251022143055"
}

###############################################
### 6. GET MY BOOKINGS
###############################################

### Get all bookings for current authenticated user
GET {{apiUrl}}/Booking/my-bookings
Authorization: Bearer {{access_token}}

###############################################
### 7. CANCEL BOOKING
###############################################

### Cancel a booking
DELETE {{apiUrl}}/Booking/1
Authorization: Bearer {{access_token}}

###############################################
### TEST SCENARIOS
###############################################

### SCENARIO 1: Complete Booking Flow (Guest)
### Step 1: Check availability
POST {{apiUrl}}/Booking/check-availability
Content-Type: application/json

{
  "roomTypeQuantities": {
    "1": 2
  },
  "checkInDate": "2025-11-01T14:00:00Z",
  "checkOutDate": "2025-11-03T12:00:00Z"
}

### Step 2: Create guest booking
POST {{apiUrl}}/Booking/guest
Content-Type: application/json

{
  "fullName": "Tran Thi B",
  "email": "tranthib@gmail.com",
  "phoneNumber": "0912345678",
  "roomTypeQuantities": {
    "1": 2
  },
  "checkInDate": "2025-11-01T14:00:00Z",
  "checkOutDate": "2025-11-03T12:00:00Z",
  "specialRequests": "Request connecting rooms",
  "bookingType": "Online"
}

### Step 3: Simulate payment confirmation
### (Use BookingId and OrderCode from Step 2 response)
POST {{apiUrl}}/Booking/confirm-payment
Content-Type: application/json

{
  "bookingId": 2,
  "orderCode": "251022143500"
}

###############################################

### SCENARIO 2: Test Holiday Pricing
### Check availability during holiday period (Christmas)
POST {{apiUrl}}/Booking/check-availability
Content-Type: application/json

{
  "roomTypeQuantities": {
    "1": 1
  },
  "checkInDate": "2025-12-24T14:00:00Z",
  "checkOutDate": "2025-12-26T12:00:00Z"
}

### Create booking during holiday
POST {{apiUrl}}/Booking/guest
Content-Type: application/json

{
  "fullName": "Le Van C",
  "email": "levanc@gmail.com",
  "phoneNumber": "0923456789",
  "roomTypeQuantities": {
    "1": 1
  },
  "checkInDate": "2025-12-24T14:00:00Z",
  "checkOutDate": "2025-12-26T12:00:00Z",
  "specialRequests": "Holiday booking",
  "bookingType": "Online"
}

###############################################

### SCENARIO 3: Test Concurrent Booking (Race Condition)
### üëâ Run these two requests quickly one after another

### User 1: Try to book same room
POST {{apiUrl}}/Booking/guest
Content-Type: application/json

{
  "fullName": "User One",
  "email": "user1@gmail.com",
  "phoneNumber": "0934567890",
  "roomTypeQuantities": {
    "1": 3
  },
  "checkInDate": "2025-11-05T14:00:00Z",
  "checkOutDate": "2025-11-07T12:00:00Z",
  "bookingType": "Online"
}

### User 2: Try to book same room (should fail if rooms locked by User 1)
POST {{apiUrl}}/Booking/guest
Content-Type: application/json

{
  "fullName": "User Two",
  "email": "user2@gmail.com",
  "phoneNumber": "0945678901",
  "roomTypeQuantities": {
    "1": 3
  },
  "checkInDate": "2025-11-05T14:00:00Z",
  "checkOutDate": "2025-11-07T12:00:00Z",
  "bookingType": "Online"
}

###############################################

### SCENARIO 4: Test Multiple Room Types
POST {{apiUrl}}/Booking/guest
Content-Type: application/json

{
  "fullName": "Pham Van D",
  "email": "phamvand@gmail.com",
  "phoneNumber": "0956789012",
  "roomTypeQuantities": {
    "1": 2,
    "2": 1,
    "3": 1
  },
  "checkInDate": "2025-11-10T14:00:00Z",
  "checkOutDate": "2025-11-15T12:00:00Z",
  "specialRequests": "Booking multiple room types for group",
  "bookingType": "Online"
}

###############################################

### SCENARIO 5: Test Booking Cancellation Flow
### Step 1: Create booking
POST {{apiUrl}}/Booking
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "customerId": 1,
  "roomTypeQuantities": {
    "1": 1
  },
  "checkInDate": "2025-11-20T14:00:00Z",
  "checkOutDate": "2025-11-22T12:00:00Z",
  "bookingType": "Online"
}

### Step 2: Cancel the booking (use BookingId from Step 1 response)
DELETE {{apiUrl}}/Booking/5
Authorization: Bearer {{access_token}}

###############################################

### SCENARIO 6: Test Invalid Dates
### Test 6.1: Check-in date in the past (should fail)
POST {{apiUrl}}/Booking/guest
Content-Type: application/json

{
  "fullName": "Invalid Date Test",
  "email": "invalid@gmail.com",
  "phoneNumber": "0967890123",
  "roomTypeQuantities": {
    "1": 1
  },
  "checkInDate": "2025-10-01T14:00:00Z",
  "checkOutDate": "2025-10-03T12:00:00Z",
  "bookingType": "Online"
}

### Test 6.2: Check-out before check-in (should fail)
POST {{apiUrl}}/Booking/guest
Content-Type: application/json

{
  "fullName": "Invalid Date Test 2",
  "email": "invalid2@gmail.com",
  "phoneNumber": "0978901234",
  "roomTypeQuantities": {
    "1": 1
  },
  "checkInDate": "2025-11-05T14:00:00Z",
  "checkOutDate": "2025-11-03T12:00:00Z",
  "bookingType": "Online"
}

###############################################

### SCENARIO 7: Test Room Type Not Found (should fail)
POST {{apiUrl}}/Booking/guest
Content-Type: application/json

{
  "fullName": "Room Not Found Test",
  "email": "notfound@gmail.com",
  "phoneNumber": "0989012345",
  "roomTypeQuantities": {
    "999": 1
  },
  "checkInDate": "2025-11-05T14:00:00Z",
  "checkOutDate": "2025-11-07T12:00:00Z",
  "bookingType": "Online"
}

###############################################

### SCENARIO 8: Test Insufficient Rooms (should fail)
### Try to book more rooms than available
POST {{apiUrl}}/Booking/guest
Content-Type: application/json

{
  "fullName": "Too Many Rooms Test",
  "email": "toomany@gmail.com",
  "phoneNumber": "0990123456",
  "roomTypeQuantities": {
    "1": 100
  },
  "checkInDate": "2025-11-05T14:00:00Z",
  "checkOutDate": "2025-11-07T12:00:00Z",
  "bookingType": "Online"
}

###############################################

### SCENARIO 9: Test Same Guest Multiple Bookings
### Guest books again with same phone number (should update customer info)
POST {{apiUrl}}/Booking/guest
Content-Type: application/json

{
  "fullName": "Nguyen Van A",
  "email": "nguyenvana@gmail.com",
  "phoneNumber": "0901234567",
  "identityCard": "001234567890",
  "address": "456 Le Loi, Q1, HCM",
  "roomTypeQuantities": {
    "2": 1
  },
  "checkInDate": "2025-11-15T14:00:00Z",
  "checkOutDate": "2025-11-17T12:00:00Z",
  "specialRequests": "Second booking for same guest",
  "bookingType": "Online"
}

###############################################

### SCENARIO 10: Test Auto-Cancel After 15 Minutes
### Step 1: Create booking
POST {{apiUrl}}/Booking/guest
Content-Type: application/json

{
  "fullName": "Auto Cancel Test",
  "email": "autocancel@gmail.com",
  "phoneNumber": "0991234567",
  "roomTypeQuantities": {
    "1": 1
  },
  "checkInDate": "2025-10-30T14:00:00Z",
  "checkOutDate": "2025-10-31T12:00:00Z",
  "specialRequests": "Testing auto-cancel",
  "bookingType": "Online"
}

### Step 2: Wait 15 minutes and check booking status
### (Booking should be automatically cancelled if not paid)
GET {{apiUrl}}/Booking/1
Authorization: Bearer {{access_token}}

###############################################
### NOTES & DOCUMENTATION
###############################################

# üìã BOOKING FLOW OVERVIEW:
# ========================
# 1. Check availability ‚úì
# 2. Create booking (locks rooms for 15 minutes) ‚úì
# 3. Get payment URL from response (PayOS)
# 4. Complete payment via PayOS link
# 5. PayOS webhook calls confirm-payment endpoint
# 6. Rooms are permanently reserved
# 7. If no payment in 15 minutes ‚Üí auto-cancel + release locks

# üîê AUTHENTICATION:
# ==================
# - Login first and copy access_token to access_token variable
# - Guest booking endpoints don't require authentication
# - Other endpoints require: Authorization: Bearer {{access_token}}

# üí∞ PRICING:
# ===========
# - Base price per room type per night
# - Holiday pricing automatically applied if booking overlaps with holiday dates
# - Total = Sum of (RoomPrice * Nights) for all rooms
# - Deposit = 30% of TotalAmount

# üîí ROOM LOCKING:
# ================
# - Rooms are locked in Redis cache when booking is created
# - Lock key format: {RoomId}_{CheckInDate}_{CheckOutDate}
# - Lock expires after 15 minutes if payment not completed
# - Prevents double-booking and race conditions

# üìù GUEST BOOKING:
# =================
# - No account required
# - System finds/creates Customer by PhoneNumber
# - Auto-updates customer info if booking again
# - Full booking history tracked by phone/email

# üè® ROOM TYPE QUANTITIES:
# ========================
# Format: Dictionary<int, int> = { RoomTypeId: Quantity }
# Example: { "1": 2, "3": 1 } = 2 Standard rooms + 1 VIP room

# ‚ö†Ô∏è IMPORTANT DATES:
# ===================
# Current date: October 22, 2025
# - Check-in must be in the future
# - Check-out must be after check-in
# - Holiday pricing applies: Dec 24-26, Tet holidays, etc.

# üß™ TEST SCENARIOS SUMMARY:
# ==========================
# ‚úì Scenario 1: Complete guest booking flow
# ‚úì Scenario 2: Holiday pricing calculation
# ‚úì Scenario 3: Concurrent booking prevention
# ‚úì Scenario 4: Multiple room types booking
# ‚úì Scenario 5: Booking cancellation
# ‚úì Scenario 6: Invalid date validations
# ‚úì Scenario 7: Room type not found error
# ‚úì Scenario 8: Insufficient rooms error
# ‚úì Scenario 9: Repeat guest booking
# ‚úì Scenario 10: Auto-cancel after timeout

# üöÄ QUICK START:
# ===============
# 1. Run login request (Section 0)
# 2. Copy access_token to @access_token variable
# 3. Test check-availability (Section 1)
# 4. Test guest booking (Section 3)
# 5. Copy BookingId and PaymentUrl from response
# 6. Test confirm-payment with BookingId

# üìä EXPECTED RESPONSES:
# ======================
# Success (200/201): { isSuccess: true, data: {...}, message: "..." }
# Error (400/404/409): { isSuccess: false, message: "Error message", statusCode: xxx }

# üí° TIPS:
# ========
# - Use check-availability before booking to avoid errors
# - BookingId and OrderCode are returned in booking response
# - Payment URL is for PayOS integration
# - My-bookings shows all bookings for logged-in user
# - Cancel booking before payment to release rooms immediately
